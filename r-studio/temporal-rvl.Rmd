---
title: "Temporal RVL"
---

```{r}
library(tidyverse)

convert_filename_to_video <- function(filename) {
  if(filename == "comm-empty") {
    return("V1")
  } else if(filename == "comm-standing") {
    return("V2")
  } else if(filename == "comm-camera-movement") {
    return("V3")
  } else if(filename == "ppt2-empty") {
    return("V4")
  } else if(filename == "ppt2-sitting") {
    return("V5")
  } else {
    stop()
  }
}

convert_type_and_thresholds_to_type <- function(type, change_threshold, invalidation_threshold) {
  if(type == "rvl") {
    return("RVL")
  }
  if(type != "trvl") {
    stop()
  }
  
  if(change_threshold == 0) {
    # TRVL without preprocessing
    return("TRVL w/o Preprocessing")
  } else if(invalidation_threshold == 0) {
    # TRVL without invalidation tolerance
    return("TRVL w/o Invalid Pixel Tolerance")
  } else {
    # Full TRVL
    return("TRVL")
  }
}

result_data <- read_csv("../output/result.csv") %>%
  mutate(video = map_chr(filename, convert_filename_to_video),
         type = pmap_chr(list(type, change_threshold, invalidation_threshold), convert_type_and_thresholds_to_type)) %>%
  mutate(video = factor(video),
         type = factor(type, c("RVL", "TRVL w/o Preprocessing", "TRVL w/o Invalid Pixel Tolerance", "TRVL"))) %>%
  select(video, type, average_compression_time, average_decompression_time, compression_ratio, average_psnr)
```
```{r}
result_data %>%
  mutate(label = map_chr(average_compression_time, ~ formatC(.x,, digits = 2, format = "f"))) %>%
  ggplot(aes(x = video, y = average_compression_time, fill = type)) +
  geom_col(position = "dodge") +
  labs(x = "Video", y = "Average Compression Time (ms)", fill = "Type") +
  geom_text(aes(label = label), position = position_dodge(0.9), vjust = -0.5)

result_data %>%
  mutate(label = map_chr(average_decompression_time, ~ formatC(.x,, digits = 2, format = "f"))) %>%
  ggplot(aes(x = video, y = average_decompression_time, fill = type)) +
  geom_col(position = "dodge") +
  labs(x = "Video", y = "Average Decompression Time (ms)", fill = "Type") +
  geom_text(aes(label = label), position = position_dodge(0.9), vjust = -0.5)

result_data %>%
  mutate(label = map_chr(compression_ratio, ~ formatC(.x,, digits = 1, format = "f"))) %>%
  ggplot(aes(x = video, y = compression_ratio, fill = type)) +
  geom_col(position = "dodge") +
  labs(x = "Video", y = "Compression Ratio", fill = "Type") +
  geom_text(aes(label = label), position = position_dodge(0.9), vjust = -0.5)
```

```{r}
get_ratio <- function(variable) {
  return(variable[[4]] / variable[[1]])
}

comparison_table <- result_data %>%
  filter(video != "V3" & video != "V4") %>%
  group_by(type) %>%
  summarise(average_compression_time = mean(average_compression_time),
            average_decompression_time = mean(average_decompression_time),
            compression_ratio = mean(compression_ratio))

comparison_table

str_c("average compression time: ", get_ratio(comparison_table$average_compression_time))
str_c("average decompression time: ", get_ratio(comparison_table$average_decompression_time))
str_c("compression ratio: ", get_ratio(comparison_table$compression_ratio))

result_data %>%
  filter(type == "TRVL w/o Invalid Pixel Tolerance") %>%
  pull(average_psnr) %>%
  { str_c("average_psnr mean: ", mean(.), ", min: ", min(.)) }

result_data %>%
  filter(type == "TRVL") %>%
  pull(average_psnr) %>%
  { str_c("average_psnr mean: ", mean(.), ", min: ", min(.)) }
```
